<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - GreenBasket</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-gradient-primary sticky-top shadow-sm">
    <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center" th:href="@{/}">
            <div class="brand-icon me-2">
                <i class="bi bi-basket2-fill fs-3"></i>
            </div>
            <span class="brand-text fw-bold">GreenBasket</span>
        </a>

        <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item">
                    <a class="nav-link px-3" th:href="@{/}">
                        <i class="bi bi-house-door me-1"></i> Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link px-3" th:href="@{/products}">
                        <i class="bi bi-grid me-1"></i> Products
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link px-3 active" th:href="@{/cart}">
                        <i class="bi bi-cart3 me-1"></i> Cart
                        <span class="badge bg-danger ms-1" id="cart-badge-nav" style="display: none;">0</span>
                    </a>
                </li>
                <li class="nav-item dropdown ms-2">
                    <a class="nav-link dropdown-toggle btn btn-outline-light rounded-pill px-3"
                       href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i>
                        <span th:text="${currentUser?.fullName}">User</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 mt-2">
                        <li>
                            <form th:action="@{/logout}" method="post">
                                <button type="submit" class="dropdown-item text-danger">
                                    <i class="bi bi-box-arrow-right me-2"></i> Logout
                                </button>
                            </form>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Page Header -->
<div class="bg-light py-4">
    <div class="container">
        <h1 class="mb-0">
            <i class="bi bi-cart3 text-success me-2"></i> Shopping Cart
        </h1>
        <p class="text-muted mb-0">Review your items before checkout</p>
    </div>
</div>

<!-- Cart Section -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <!-- Cart Items -->
            <div class="col-lg-8 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Cart Items (<span id="itemCount">0</span>)</h5>
                            <button class="btn btn-sm btn-outline-danger" id="clearCartBtn" style="display: none;">
                                <i class="bi bi-trash me-1"></i> Clear Cart
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Empty Cart -->
                        <div id="emptyCart" class="text-center py-5">
                            <i class="bi bi-cart-x display-1 text-muted"></i>
                            <h3 class="mt-3">Your cart is empty</h3>
                            <p class="text-muted mb-4">Add some products to get started!</p>
                            <a th:href="@{/products}" class="btn btn-success rounded-pill px-4">
                                <i class="bi bi-shop me-2"></i> Browse Products
                            </a>
                        </div>

                        <!-- Cart Items List -->
                        <div id="cartItems" class="list-group list-group-flush" style="display: none;">
                            <!-- Items will be loaded by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                    <div class="card-header bg-success text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <strong id="subtotal">₹0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Delivery Fee</span>
                            <strong id="deliveryFee">₹0.00</strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-4">
                            <h5 class="mb-0">Total</h5>
                            <h5 class="mb-0 text-success" id="total">₹0.00</h5>
                        </div>

                        <div class="alert alert-info small mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            Free delivery on orders above ₹500
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg rounded-pill" id="checkoutBtn" disabled>
                                <i class="bi bi-credit-card me-2"></i> Proceed to Checkout
                            </button>
                            <a th:href="@{/products}" class="btn btn-outline-success rounded-pill">
                                <i class="bi bi-plus-circle me-2"></i> Continue Shopping
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Footer -->
<footer class="bg-dark text-white py-4 mt-5">
    <div class="container text-center">
        <small>&copy; 2025 GreenBasket. All rights reserved.</small>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/cart.js}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Cart page loaded');
        renderCartPage();

        // Clear cart button
        document.getElementById('clearCartBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all items from cart?')) {
                clearCart();
                renderCartPage();
                showNotification('Cart cleared', 'info');
            }
        });

        // Update badge in nav
        updateCartBadge();
        const badge = document.getElementById('cart-badge-nav');
        if (badge) {
            const totalItems = cart.length;
            if (totalItems > 0) {
                badge.textContent = totalItems;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
    });

    function renderCartPage() {
        console.log('Rendering cart page. Cart items:', cart.length);

        const cartItemsContainer = document.getElementById('cartItems');
        const emptyCart = document.getElementById('emptyCart');
        const itemCount = document.getElementById('itemCount');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const clearBtn = document.getElementById('clearCartBtn');

        if (cart.length === 0) {
            emptyCart.style.display = 'block';
            cartItemsContainer.style.display = 'none';
            checkoutBtn.disabled = true;
            clearBtn.style.display = 'none';
            itemCount.textContent = '0';
            updateSummary(0);
            return;
        }

        emptyCart.style.display = 'none';
        cartItemsContainer.style.display = 'block';
        checkoutBtn.disabled = false;
        clearBtn.style.display = 'block';
        itemCount.textContent = cart.length;

        let html = '';
        let subtotal = 0;

        cart.forEach(function(item) {
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;

            html += `
                <div class="list-group-item p-4">
                    <div class="row align-items-center">
                        <div class="col-md-5">
                            <h6 class="mb-1 fw-bold">${item.name}</h6>
                            <p class="text-muted small mb-0">₹${item.price.toFixed(2)}/kg</p>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-outline-secondary rounded-circle"
                                        onclick="decreaseQuantity(${item.productId})"
                                        style="width: 32px; height: 32px; padding: 0;">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <input type="number" class="form-control form-control-sm text-center"
                                       style="width: 70px;" value="${item.quantity}"
                                       onchange="updateItemQuantity(${item.productId}, this.value)"
                                       min="0.5" step="0.5">
                                <button class="btn btn-sm btn-outline-secondary rounded-circle"
                                        onclick="increaseQuantity(${item.productId})"
                                        style="width: 32px; height: 32px; padding: 0;">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <small class="text-muted">kg</small>
                        </div>
                        <div class="col-md-3 text-end">
                            <h5 class="mb-0 text-success">₹${itemTotal.toFixed(2)}</h5>
                        </div>
                        <div class="col-md-1 text-end">
                            <button class="btn btn-sm btn-outline-danger rounded-circle"
                                    onclick="removeItemFromCart(${item.productId})"
                                    style="width: 36px; height: 36px; padding: 0;">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        cartItemsContainer.innerHTML = html;
        updateSummary(subtotal);
    }

    function updateSummary(subtotal) {
        const deliveryFee = subtotal >= 500 ? 0 : (subtotal > 0 ? 50 : 0);
        const total = subtotal + deliveryFee;

        document.getElementById('subtotal').textContent = '₹' + subtotal.toFixed(2);
        document.getElementById('deliveryFee').textContent = deliveryFee === 0 ? 'FREE' : '₹' + deliveryFee.toFixed(2);
        document.getElementById('total').textContent = '₹' + total.toFixed(2);
    }

    function increaseQuantity(productId) {
        const item = cart.find(i => i.productId === productId);
        if (item) {
            item.quantity = parseFloat(item.quantity) + 0.5;
            saveCart();
            renderCartPage();
            updateCartBadge();
        }
    }

    function decreaseQuantity(productId) {
        const item = cart.find(i => i.productId === productId);
        if (item && item.quantity > 0.5) {
            item.quantity = parseFloat(item.quantity) - 0.5;
            saveCart();
            renderCartPage();
            updateCartBadge();
        }
    }

    function updateItemQuantity(productId, newQuantity) {
        const quantity = parseFloat(newQuantity);
        if (quantity > 0) {
            updateQuantity(productId, quantity);
            renderCartPage();
            updateCartBadge();
        }
    }

    function removeItemFromCart(productId) {
        if (confirm('Remove this item from cart?')) {
            const removed = removeFromCart(productId);
            if (removed) {
                renderCartPage();
                updateCartBadge();
                showNotification('Item removed from cart', 'info');
            }
        }
    }

    document.getElementById('checkoutBtn').addEventListener('click', function() {
        if (cart.length > 0) {
            window.location.href = '/checkout';
        }
    });
</script>
</body>
</html>
