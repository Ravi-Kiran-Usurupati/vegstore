<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - GreenBasket</title>
    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">

    <style>
        .checkout-step {
            border-left: 3px solid #10b981;
            padding-left: 20px;
            margin-bottom: 30px;
        }
        .order-summary-item {
            border-bottom: 1px solid #e5e7eb;
            padding: 15px 0;
        }
        .order-summary-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-gradient-primary sticky-top shadow-sm">
    <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center" th:href="@{/}">
            <div class="brand-icon me-2">
                <i class="bi bi-basket2-fill fs-3"></i>
            </div>
            <span class="brand-text fw-bold">GreenBasket</span>
        </a>

        <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item">
                    <a class="nav-link px-3" th:href="@{/}">
                        <i class="bi bi-house-door me-1"></i> Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link px-3" th:href="@{/products}">
                        <i class="bi bi-grid me-1"></i> Products
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link px-3 position-relative" th:href="@{/cart}">
                        <i class="bi bi-cart3 fs-5"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-badge"
                              id="cart-badge" style="display: none;">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link px-3" th:href="@{/my-orders}">
                        <i class="bi bi-box-seam me-1"></i> My Orders
                    </a>
                </li>
                <li class="nav-item  ms-2">
                    <a class="nav-link  btn btn-outline-dark rounded-pill px-3"
                       href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i>
                        <span th:text="${currentUser?.fullName}">User</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 mt-2">
                        <li>
                            <form th:action="@{/logout}" method="post">
                                <button type="submit" class="dropdown-item text-danger">
                                    <i class="bi bi-box-arrow-right me-2"></i> Logout
                                </button>
                            </form>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Progress Steps -->
<div class="bg-light py-3">
    <div class="container">
        <div class="row text-center">
            <div class="col-4">
                <div class="step-completed">
                    <i class="bi bi-cart-check-fill fs-3 text-success"></i>
                    <p class="mb-0 mt-2 small">Cart</p>
                </div>
            </div>
            <div class="col-4">
                <div class="step-active">
                    <i class="bi bi-credit-card-fill fs-3 text-success"></i>
                    <p class="mb-0 mt-2 small fw-bold">Checkout</p>
                </div>
            </div>
            <div class="col-4">
                <div class="step-pending">
                    <i class="bi bi-check-circle fs-3 text-muted"></i>
                    <p class="mb-0 mt-2 small text-muted">Confirmation</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Section -->
<section class="py-5">
    <div class="container">
        <!-- Loading Indicator -->
        <div id="loadingCheckout" class="text-center py-5">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading checkout...</p>
        </div>

        <!-- Empty Cart Warning -->
        <div id="emptyCartWarning" class="text-center py-5" style="display: none;">
            <i class="bi bi-cart-x display-1 text-muted"></i>
            <h3 class="mt-3">Your cart is empty</h3>
            <p class="text-muted mb-4">Add some products before proceeding to checkout</p>
            <a th:href="@{/products}" class="btn btn-success rounded-pill px-4">
                <i class="bi bi-shop me-2"></i> Browse Products
            </a>
        </div>

        <!-- Checkout Form -->
        <div id="checkoutForm" class="row" style="display: none;">
            <div class="col-lg-8 mb-4">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">
                            <i class="bi bi-geo-alt-fill text-success me-2"></i> Delivery Information
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <form id="orderForm" th:action="@{/checkout/place-order}" method="post">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Full Name *</label>
                                    <input type="text" name="customerName" class="form-control form-control-lg"
                                           th:value="${currentUser?.fullName}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Phone Number *</label>
                                    <input type="tel" name="customerPhone" class="form-control form-control-lg"
                                           pattern="[0-9]{10}" placeholder="10-digit number" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Delivery Address *</label>
                                    <textarea name="deliveryAddress" class="form-control" rows="3"
                                              placeholder="House no., Street, Area, City, State, PIN" required></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">City *</label>
                                    <input type="text" name="city" class="form-control form-control-lg"
                                           value="Vijayawada" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">PIN Code *</label>
                                    <input type="text" name="pincode" class="form-control form-control-lg"
                                           pattern="[0-9]{6}" placeholder="6-digit PIN" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Delivery Instructions (Optional)</label>
                                    <textarea name="deliveryNotes" class="form-control" rows="2"
                                              placeholder="Any specific delivery instructions..."></textarea>
                                </div>
                            </div>

                            <hr class="my-4">

                            <h5 class="mb-3">
                                <i class="bi bi-credit-card text-success me-2"></i> Payment Method
                            </h5>
                            <div class="form-check mb-3 p-3 border rounded">
                                <input class="form-check-input" type="radio" name="paymentMethod"
                                       id="cod" value="COD" checked>
                                <label class="form-check-label ms-2" for="cod">
                                    <strong>Cash on Delivery (COD)</strong>
                                    <p class="text-muted small mb-0">Pay when you receive your order</p>
                                </label>
                            </div>
                            <div class="form-check p-3 border rounded">
                                <input class="form-check-input" type="radio" name="paymentMethod"
                                       id="online" value="ONLINE">
                                <label class="form-check-label ms-2" for="online">
                                    <strong>Online Payment</strong>
                                    <p class="text-muted small mb-0">UPI, Cards, Net Banking</p>
                                </label>
                            </div>

                            <!-- Hidden field for cart data -->
                            <input type="hidden" name="cartData" id="cartDataInput">
                        </form>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                    <div class="card-header bg-success text-white py-3">
                        <h5 class="mb-0">
                            <i class="bi bi-receipt-cutoff me-2"></i> Order Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Order Items -->
                        <div id="orderItems" class="mb-3">
                            <!-- Items will be loaded here -->
                        </div>

                        <hr>

                        <!-- Price Breakdown -->
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal (<span id="itemCountSummary">0</span> items)</span>
                            <strong id="subtotalAmount">₹0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Delivery Fee</span>
                            <strong id="deliveryFeeAmount">₹50.00</strong>
                        </div>

                        <div class="alert alert-info small mb-3">
                            <i class="bi bi-gift me-2"></i>
                            Free delivery on orders above ₹500
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between mb-4">
                            <h5 class="mb-0">Total Amount</h5>
                            <h5 class="mb-0 text-success" id="totalAmount">₹0.00</h5>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success btn-lg rounded-pill"
                                    id="placeOrderBtn">
                                <i class="bi bi-check-circle me-2"></i> Place Order
                            </button>
                            <a th:href="@{/cart}" class="btn btn-outline-secondary rounded-pill">
                                <i class="bi bi-arrow-left me-2"></i> Back to Cart
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Footer -->
<footer class="bg-dark text-white py-4 mt-5">
    <div class="container text-center">
        <small>&copy; 2025 GreenBasket. All rights reserved.</small>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/cart.js}"></script>

<script>
    let orderSubtotal = 0;
    let orderTotal = 0;

    document.addEventListener('DOMContentLoaded', async function() {
        console.log('Checkout page loaded');

        // Load and render checkout
        await loadCheckoutData();

        // Place order button
        document.getElementById('placeOrderBtn').addEventListener('click', function() {
            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }

            // Validate form
            const form = document.getElementById('orderForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Set cart data in hidden field
            document.getElementById('cartDataInput').value = JSON.stringify(cart);

            // Submit form
            form.submit();
        });
    });

    async function loadCheckoutData() {
        try {
            // Show loading
            document.getElementById('loadingCheckout').style.display = 'block';
            document.getElementById('emptyCartWarning').style.display = 'none';
            document.getElementById('checkoutForm').style.display = 'none';

            // Load cart from backend
            await loadCartFromBackend();

            console.log('Cart loaded. Items:', cart.length);

            // Hide loading
            document.getElementById('loadingCheckout').style.display = 'none';

            if (cart.length === 0) {
                document.getElementById('emptyCartWarning').style.display = 'block';
                return;
            }

            document.getElementById('checkoutForm').style.display = 'flex';
            renderOrderItems(cart);
            calculateOrderSummary(cart);
            updateCartBadge();
        } catch (error) {
            console.error('Error loading checkout:', error);
            document.getElementById('loadingCheckout').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading checkout. Please try again.
                </div>
            `;
        }
    }

    function renderOrderItems(cart) {
        const container = document.getElementById('orderItems');
        let html = '';

        cart.forEach(function(item) {
            const itemTotal = item.price * item.quantity;
            html += `
                <div class="order-summary-item">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${item.name}</h6>
                            <small class="text-muted">${item.quantity} kg × ₹${item.price.toFixed(2)}</small>
                        </div>
                        <strong class="text-success ms-2">₹${itemTotal.toFixed(2)}</strong>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function calculateOrderSummary(cart) {
        // Calculate subtotal
        orderSubtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

        // Calculate delivery fee (free if subtotal >= 500)
        const deliveryFee = orderSubtotal >= 500 ? 0 : 50;

        // Calculate total
        orderTotal = orderSubtotal + deliveryFee;

        // Update UI
        document.getElementById('itemCountSummary').textContent = cart.length;
        document.getElementById('subtotalAmount').textContent = '₹' + orderSubtotal.toFixed(2);
        document.getElementById('deliveryFeeAmount').textContent = deliveryFee === 0 ? 'FREE' : '₹' + deliveryFee.toFixed(2);
        document.getElementById('totalAmount').textContent = '₹' + orderTotal.toFixed(2);

        console.log('Order Summary:', {
            subtotal: orderSubtotal,
            deliveryFee: deliveryFee,
            total: orderTotal
        });
    }
</script>
</body>
</html>
